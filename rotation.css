/* Map rotation visual layer */
.map-container.map-rotated {
  overflow: hidden;
}

.map-container.map-rotated #map {
  transform: rotate(var(--map-rotation-deg, 0deg)) scale(var(--map-rotation-scale, 1));
  transform-origin: 50% 50%;
  transition: transform 200ms ease;
  will-change: transform;
}

/* 讓 Leaflet 控制項與彈窗在地圖旋轉時保持正向與正常尺寸 */
.map-container.map-rotated .leaflet-control-container,
.map-container.map-rotated .leaflet-top,
.map-container.map-rotated .leaflet-bottom,
.map-container.map-rotated .leaflet-popup-pane,
.map-container.map-rotated .leaflet-tooltip-pane {
  transform: rotate(calc(-1 * var(--map-rotation-deg, 0deg))) scale(var(--inverse-map-rotation-scale, 1));
  transform-origin: 50% 50%;
}

/* Rotate button placement */
.rotate-btn {
  position: fixed !important;
  right: 12px;
  top: 160px;
  z-index: 10020; /* 高於其他浮動元素，避免被覆蓋 */
  pointer-events: auto;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  min-width: 44px;
  min-height: 44px;
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.95);
  border: 2px solid rgba(99, 102, 241, 0.3);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
  backdrop-filter: blur(10px);
  color: #4a5568;
}

.rotate-btn:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.25);
}

.rotate-btn:active {
  transform: translateY(-1px) scale(0.98);
}

.rotate-btn.active {
  background: rgba(99, 102, 241, 0.15);
  border-color: rgba(99, 102, 241, 0.45);
}

/* Ensure map uses dynamic viewport height when rotated/fullscreen */
.map-container,
.map-container.fullscreen {
  height: 100dvh;
  height: 100svh;
  width: 100vw;
}

.map-container.fullscreen #map {
  height: 100dvh;
  height: 100svh;
  width: 100vw;
}

/* 在開啟地圖旋轉時，將所有標註點縮小（避開 Leaflet 內聯 transform） */
/* 對於 img 型標記（默認圖示），直接縮放元素本身，但以左上角為基準避免位移 */
.map-container.map-rotated .leaflet-marker-icon:not(.current-location-marker) {
  scale: var(--marker-combined-scale, 0.75);
  transform-origin: 50% 50%;
  transition: scale 120ms ease;
}

/* 對於 divIcon 型標記，縮放其內部元素，避免覆蓋外層的 translate */
.map-container.map-rotated .leaflet-div-icon > *,
.map-container.map-rotated .custom-marker-icon > * {
  transform: scale(var(--marker-combined-scale, 0.75));
  transform-origin: 50% 50%;
  transition: transform 120ms ease;
}

/* 當前位置標記（脈衝容器）同步縮放 */
.map-container.map-rotated .current-location-marker .location-pulse {
  transform: scale(var(--marker-combined-scale, 0.75));
  transform-origin: 50% 50%;
  transition: none; /* 避免縮放動畫導致定位點視覺漂移 */
}

/* 旋轉模式：定位點中心圓點同步縮放（不影響定位錨點） */
.map-container.map-rotated .current-location-marker .location-dot {
  transform: scale(var(--marker-combined-scale, 0.75));
  transform-origin: 50% 50%;
  transition: none;
}

/* 在旋轉模式下，避免外層 hover/active 導致位置漂移 */
.map-container.map-rotated .leaflet-marker-icon:hover,
.map-container.map-rotated .leaflet-marker-icon:active {
  transform: none !important;
}